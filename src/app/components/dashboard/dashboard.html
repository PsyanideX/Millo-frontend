<div class="millo-container" cdkDropListGroup>
  <header class="app-header">
    <div class="board-info">
      <button class="icon-btn hamburger" (click)="toggleAppsMenu()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      <h1>
        {{ currentBoard()?.name || 'Millo Board' }}
        @if (currentBoard() && currentBoard()?.ownerId !== authService.currentUser()?.id) {
        <span class="header-shared-badge">Invitado</span>
        }
      </h1>
      <button class="share-btn" (click)="openShareModal()"
        *ngIf="currentBoard()?.ownerId === authService.currentUser()?.id">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="8.5" cy="7" r="4"></circle>
          <line x1="20" y1="8" x2="20" y2="14"></line>
          <line x1="23" y1="11" x2="17" y2="11"></line>
        </svg>
        Compartir
      </button>

      <!-- Selection Actions -->
      <div class="selection-actions" *ngIf="selectedTaskIds().size > 0">
        <span class="selection-count">{{ selectedTaskIds().size }} seleccionado(s)</span>
        <button class="bulk-move-btn" (click)="openMoveTasksModal()">
          Mover a...
        </button>
        <button class="clear-selection-btn" (click)="clearSelection()">
          Cancelar
        </button>
      </div>
    </div>

    <div class="filters">
      <button (click)="selectCategory(null)" [class.active]="!selectedCategoryId()">Todo</button>
      @for (cat of categories(); track cat.id) {
      <button (click)="selectCategory(cat.id)" [class.active]="selectedCategoryId() === cat.id">
        {{ cat.name }}
      </button>
      }
    </div>
  </header>

  <main class="board-canvas" #boardCanvas>
    @if (isLoading()) {
    <div class="board-loading-container">
      <div class="spinner"></div>
      <span>Cargando tablero...</span>
    </div>
    } @else {
    <div class="lists-container">
      @for (column of columns(); track column.id) {
      <section class="column">
        <div class="column-header">
          <h2>{{ column.name }} <span>({{ column.tasks?.length || 0 }})</span></h2>
          <button class="menu-btn">¬∑¬∑¬∑</button>
        </div>

        <div [id]="column.id" cdkDropList [cdkDropListData]="column.tasks" [cdkDropListConnectedTo]="columnIds()"
          (cdkDropListDropped)="drop($event, column.id)" class="task-list">

          @for (task of column.tasks; track task.id) {
          @if (!selectedCategoryId() || task.categoryId === selectedCategoryId()) {
          <article class="card" cdkDrag [cdkDragData]="task" (cdkDragStarted)="onDragStarted()"
            (cdkDragEnded)="onDragEnded()"
            (click)="selectedTaskIds().size > 0 ? toggleTaskSelection(task.id, $event) : openEditCardModal(task)"
            [class.selected]="selectedTaskIds().has(task.id)">
            <div class="card-selection-overlay" (click)="toggleTaskSelection(task.id, $event)">
              <div class="selection-checkbox" [class.checked]="selectedTaskIds().has(task.id)"></div>
            </div>
            <div class="card-content">
              <div class="card-tags">
                <div class="category-tag" [style.background-color]="task.category?.color" title="Categor√≠a"></div>
                <span class="priority-tag" [class]="(task.priority || 'Low').toLowerCase()">{{ task.priority || 'Low'
                  }}</span>
                <span *ngIf="isUrgent(task.endDate)" class="urgent-icon" title="Vence pronto">‚è∞</span>
              </div>
              <h3>{{ task.title }}</h3>
              <p *ngIf="task.description" class="description">{{ task.description }}</p>
              <div class="card-footer">
                <span class="effort" *ngIf="task.effortPoints">{{ task.effortPoints }} h</span>
                <span class="cost" *ngIf="getTaskCostTotal(task) > 0">{{ getTaskCostTotal(task).toFixed(2) }}‚Ç¨</span>
              </div>
            </div>
          </article>
          }
          }

          <div class="column-footer" *ngIf="column.tasks && column.tasks.length > 0">
            <span class="total-effort">Total: {{ getColumnEffortTotal(column) }} h</span>
          </div>

          <button class="add-card-btn" (click)="openAddCardModal(column.id)">+ A√±adir una tarjeta</button>
        </div>
      </section>
      }

      <button class="add-list-btn" (click)="openAddColumnModal()">+ A√±adir otra columna</button>
    </div>
    }
  </main>

  <!-- Custom Modal -->
  @if (isModalOpen()) {
  <div class="modal-overlay" (mousedown)="handleOverlayMouseDown($event)" (click)="handleOverlayClick($event)">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ modalTitle() }}</h2>
        <button class="close-btn" (click)="closeModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="form-group" *ngIf="modalMode() !== 'MOVE'">
          <label>T√≠tulo</label>
          <input type="text" [value]="formTitle()" (input)="formTitle.set($any($event.target).value)"
            placeholder="Introduce un t√≠tulo..." autofocus>
        </div>

        <div class="move-selection-section" *ngIf="modalMode() === 'MOVE'">
          <div class="form-group">
            <label>Seleccionar Tablero Destino</label>
            <select [ngModel]="targetBoardId()" (ngModelChange)="onTargetBoardChange($event)">
              <option [ngValue]="null" disabled>Elige un tablero...</option>
              @for (board of boards(); track board.id) {
              @if (board.id !== currentBoard()?.id) {
              <option [value]="board.id">{{ board.name }}</option>
              }
              }
            </select>
          </div>

          @if (targetBoardId()) {
          <div class="form-group">
            <label>Seleccionar Columna</label>
            <select [ngModel]="targetColumnId()" (ngModelChange)="targetColumnId.set($event)">
              <option [ngValue]="null" disabled>Elige una columna...</option>
              @for (col of targetBoardColumns(); track col.id) {
              <option [value]="col.id">{{ col.name }}</option>
              }
            </select>
          </div>
          }
        </div>

        <div class="form-group" *ngIf="modalMode() !== 'LIST' && modalMode() !== 'MOVE'">
          <label>Descripci√≥n</label>
          <textarea [value]="formDescription()" (input)="formDescription.set($any($event.target).value)"
            placeholder="A√±ade una descripci√≥n m√°s detallada..."></textarea>
        </div>

        <div class="modal-row" *ngIf="modalMode() !== 'LIST' && modalMode() !== 'BOARD' && modalMode() !== 'MOVE'">
          <div class="form-group flex-1">
            <label>Esfuerzo (horas)</label>
            <input type="number" [value]="formEffortPoints()"
              (input)="formEffortPoints.set($any($event.target).valueAsNumber)" min="0">
          </div>

          <div class="form-group flex-2">
            <label>Categor√≠a</label>
            <div class="select-wrapper">
              <select [ngModel]="formCategoryId()" (ngModelChange)="formCategoryId.set($event)"
                *ngIf="!showNewCategoryForm()">
                <option [ngValue]="null">Sin categor√≠a</option>
                @for (cat of categories(); track cat.id) {
                <option [ngValue]="cat.id">{{ cat.name }}</option>
                }
              </select>
              <button class="small-btn" (click)="toggleCategoryForm()">
                {{ showNewCategoryForm() ? 'Cancelar' : '+ Nueva' }}
              </button>
            </div>
          </div>
        </div>

        <div class="modal-row" *ngIf="modalMode() !== 'LIST' && modalMode() !== 'BOARD' && modalMode() !== 'MOVE'">
          <div class="form-group flex-1">
            <label>Prioridad</label>
            <select [value]="formPriority()" (change)="formPriority.set($any($event.target).value)">
              <option value="Low">Baja</option>
              <option value="Medium">Media</option>
              <option value="High">Alta</option>
            </select>
          </div>
          <div class="form-group flex-1">
            <label>Fecha L√≠mite</label>
            <input type="date" [value]="formEndDate()" (change)="formEndDate.set($any($event.target).value)">
          </div>
        </div>

        <!-- Inline Category Creation -->
        <div class="category-creator"
          *ngIf="showNewCategoryForm() && modalMode() !== 'LIST' && modalMode() !== 'BOARD' && modalMode() !== 'MOVE'">
          <div class="form-group">
            <label>Nueva Categor√≠a</label>
            <div class="creator-row">
              <input type="text" [value]="newCategoryName()" (input)="newCategoryName.set($any($event.target).value)"
                placeholder="Nombre...">
              <input type="color" [value]="newCategoryColor()"
                (input)="newCategoryColor.set($any($event.target).value)">
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div class="items-section" *ngIf="modalMode() !== 'LIST' && modalMode() !== 'BOARD' && modalMode() !== 'MOVE'">
          <button class="toggle-items-btn" (click)="toggleItemsForm()">
            {{ showItemsForm() ? '‚ñº' : '‚ñ∂' }} Art√≠culos ({{ formItems().length }})
          </button>

          <div class="items-form" *ngIf="showItemsForm()">
            <!-- New Item Input -->
            <div class="add-item-form">
              <div class="form-group">
                <label>Nombre del art√≠culo</label>
                <input type="text" [value]="newItemName()" (input)="newItemName.set($any($event.target).value)"
                  placeholder="Nombre del art√≠culo..." (keyup.enter)="addItem()">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Cantidad</label>
                  <input type="number" [value]="newItemQuantity()"
                    (input)="newItemQuantity.set($any($event.target).valueAsNumber)" min="1" max="9999">
                </div>

                <div class="form-group">
                  <label>Precio (‚Ç¨)</label>
                  <input type="number" [value]="newItemPrice()"
                    (input)="newItemPrice.set($any($event.target).valueAsNumber)" min="0" step="0.01">
                </div>

                <button class="add-item-btn" (click)="addItem()">A√±adir</button>
              </div>
            </div>

            <!-- Items List -->
            <div class="items-list" *ngIf="formItems().length > 0">
              @for (item of formItems(); track $index) {
              <div class="item-row">
                <div class="item-info">
                  <span class="item-name">{{ item.name }}</span>
                  <span class="item-details">{{ item.quantity }} x {{ item.price.toFixed(2) }}‚Ç¨ = {{ (item.quantity *
                    item.price).toFixed(2) }}‚Ç¨</span>
                </div>
                <button class="remove-item-btn" (click)="removeItem($index)">‚úï</button>
              </div>
              }

              <div class="items-total">
                <span>Total art√≠culos:</span>
                <span class="total-price">{{ itemsTotal().toFixed(2) }}‚Ç¨</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeModal()">Cancelar</button>
        <button class="submit-btn"
          [disabled]="(modalMode() !== 'MOVE' && !formTitle()) || (modalMode() === 'MOVE' && (!targetBoardId() || !targetColumnId()))"
          (click)="submitModal()">
          @if (modalMode() === 'LIST') {
          A√±adir columna
          } @else if (modalMode() === 'EDIT') {
          Guardar cambios
          } @else if (modalMode() === 'BOARD') {
          Crear tablero
          } @else if (modalMode() === 'MOVE') {
          Mover {{ selectedTaskIds().size }} tareas
          } @else {
          A√±adir tarjeta
          }
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Floating Action Button -->
  <div class="fab-container">
    <button class="fab-main" (click)="toggleMenuOptions()" [class.open]="showMenuOptions()">
      ‚öôÔ∏è
    </button>

    @if (showMenuOptions()) {
    <button class="fab-option" (click)="openFinancialSummary()">
      üìä Resumen Financiero
    </button>
    <button class="fab-option" (click)="openGanttConfig()">
      üìÖ Diagrama de Gantt
    </button>
    }
  </div>

  <!-- Apps Menu Sidebar -->
  @if (isAppsMenuOpen()) {
  <div class="apps-menu-overlay" (click)="toggleAppsMenu()">
    <aside class="apps-sidebar" (click)="$event.stopPropagation()">
      <header>
        <div class="sidebar-header-content">
          <div class="logo-circle">M</div>
          <h2>Mis Tableros</h2>
        </div>
        <button class="close-sidebar-btn" (click)="toggleAppsMenu()">&times;</button>
      </header>

      <div class="sidebar-content">
        <!-- Tablero Principal -->
        @if (primaryBoardSignal()) {
        <div class="sidebar-section">
          <h3>Tablero Principal</h3>
          <ul class="board-list">
            @let pBoard = primaryBoardSignal()!;
            <li [class.active]="currentBoard()?.id === pBoard.id" (click)="switchBoard(pBoard.id)">
              <div class="board-item-content">
                <span class="board-color-dot" [class.owning]="pBoard.ownerId === authService.currentUser()?.id"
                  [class.shared]="pBoard.ownerId !== authService.currentUser()?.id"
                  [style.background-color]="pBoard.ownerId === authService.currentUser()?.id ? '#e3a008' : '#4a90e2'"></span>
                <span class="board-name">{{ pBoard.name }}</span>
              </div>
              <div class="board-item-actions">
                @if (pBoard.ownerId !== authService.currentUser()?.id) { <span class="shared-badge">Invitado</span> }
                <span class="primary-badge">Principal</span>
                @if (pBoard.ownerId === authService.currentUser()?.id && boards().length > 1) {
                <button class="delete-board-btn" (click)="deleteBoard($event, pBoard.id)" title="Eliminar tablero">
                  üóëÔ∏è
                </button>
                }
              </div>
            </li>
          </ul>
        </div>
        }

        <!-- Tableros Secundarios -->
        @if (secondaryBoards().length > 0 || sharedBoards().length > 0) {
        <div class="sidebar-section">
          <h3>Tableros Secundarios</h3>
          <ul class="board-list">
            <!-- Owned Secondary Boards -->
            @for (board of secondaryBoards(); track board.id) {
            <li [class.active]="currentBoard()?.id === board.id" (click)="switchBoard(board.id)">
              <div class="board-item-content">
                <span class="board-color-dot owning" [style.background-color]="'#e3a008'"></span>
                <span class="board-name">{{ board.name }}</span>
              </div>
              <div class="board-item-actions">
                <button class="set-primary-btn" (click)="setPrimaryBoard($event, board.id)"
                  title="Marcar como principal">
                  ‚≠ê
                </button>
                @if (board.ownerId === authService.currentUser()?.id) {
                <button class="delete-board-btn" (click)="deleteBoard($event, board.id)" title="Eliminar tablero">
                  üóëÔ∏è
                </button>
                }
              </div>
            </li>
            }

            <!-- Shared Boards -->
            @for (board of sharedBoards(); track board.id) {
            <li [class.active]="currentBoard()?.id === board.id" (click)="switchBoard(board.id)">
              <div class="board-item-content">
                <span class="board-color-dot shared" [style.background-color]="'#4a90e2'"></span>
                <span class="board-name">{{ board.name }}</span>
              </div>
              <div class="board-item-actions">
                <button class="set-primary-btn" (click)="setPrimaryBoard($event, board.id)"
                  title="Marcar como principal">
                  ‚≠ê
                </button>
                <span class="shared-badge">Invitado</span>
              </div>
            </li>
            }
          </ul>
        </div>
        }

        <div class="sidebar-section">
          <button class="create-board-btn" (click)="openAddBoardModal()">
            <span>+</span> Crear nuevo tablero
          </button>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="avatar">{{ authService.currentUser()?.name?.charAt(0)?.toUpperCase() || 'U' }}</div>
          <div class="user-info">
            <span class="username">{{ authService.currentUser()?.name || 'Usuario' }}</span>
            <span class="workspace">{{ currentBoard()?.name || 'Tablero Principal' }}</span>
          </div>
        </div>
        <button class="logout-btn" (click)="logout()" title="Cerrar sesi√≥n">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>
    </aside>
  </div>
  }

  <app-gantt-chart [columns]="columns()" [boardName]="currentBoard()?.name || ''"></app-gantt-chart>
  <app-financial-summary [columns]="columns()" [categories]="categories()"></app-financial-summary>
  <app-board-members [boardId]="currentBoard()?.id || ''" [ownerId]="currentBoard()?.ownerId || ''"></app-board-members>
</div>